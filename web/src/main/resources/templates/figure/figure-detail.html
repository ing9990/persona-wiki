<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">

<head>
  <title th:text="${detailsResult.getDisplayName()} + ' - 국민사형투표'">인물 상세</title>
  <script async
          src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1448769500494356"
          crossorigin="anonymous"></script>
  <meta name="description" th:content="${#strings.abbreviate(detailsResult.bio,15)}">

  <!-- CSS 파일 -->
  <link rel="stylesheet" href="/css/comment-reply.css">
  <link rel="stylesheet" href="/css/comment-style.css">
  <link rel="stylesheet" href="/css/fingure-detail.css">
  <link rel="stylesheet" href="/css/scroll-to-top.css">
  <link rel="stylesheet" href="/css/vote.css">
  <link rel="stylesheet" href="/css/comment-form.css">
  <link rel="stylesheet" href="/css/add-reply-form.css">

  <!-- 인라인 스타일 -->
  <style>
    /* 모바일 환경에서 댓글 버튼 레이아웃 최적화 */
    @media (max-width: 640px) {
      /* 댓글과 답글 버튼 그룹에 적용 */
      .comment-footer, .reply-footer,
      .like-button, .dislike-button, .add-reply-button,
      .view-replies-btn, .like-btn, .dislike-btn {
        margin-right: 0.5rem !important;
      }

      /* 버튼 그룹의 줄바꿈 처리 개선 */
      .flex.items-center.text-sm.text-gray-500,
      .reply-footer {
        flex-wrap: wrap;
        row-gap: 0.5rem;
        column-gap: 0.75rem;
      }

      /* 아이콘과 텍스트 간격 조정 */
      .far, .fa-regular {
        margin-right: 0.25rem !important;
      }

      /* 버튼 간 좌우 간격 조정 */
      .like-button, .dislike-button, .add-reply-button, .view-replies-btn {
        margin-right: 0.35rem;
      }
    }

    /* Bio 모달 관련 스타일 */
    #bio-toggle {
      opacity: 0.7;
      font-size: 0.875rem;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    #bio-toggle:hover {
      opacity: 1;
      transform: scale(1.1);
    }

    #bio-modal {
      transition: opacity 0.3s ease;
      opacity: 0;
    }

    #bio-modal.show {
      opacity: 1;
      display: flex;
    }

    #bio-modal .bg-gray-800 {
      max-height: 80vh;
      overflow-y: auto;
    }

    @media (max-width: 640px) {
      #bio-modal .bg-gray-800 {
        max-height: 70vh;
        width: 90%;
      }
    }

    /* 모달 애니메이션 */
    @keyframes modalFadeIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    #bio-modal .bg-gray-800 {
      animation: modalFadeIn 0.3s ease forwards;
    }
  </style>
</head>

<body>
<div layout:fragment="content">
  <div id="comment-section" th:attr="data-figure-id=${detailsResult.id}"></div>

  <!-- 인물 프로필 헤더 -->
  <section class="profile-header mb-8 shadow-lg" th:attr="data-figure-id=${detailsResult.getId()}">
    <img th:src="${detailsResult.getCategoryImage()}" th:alt="${detailsResult.getDisplayName()}"
         class="profile-header-image">
    <div class="profile-header-content">
      <div class="flex items-end justify-between w-full">
        <div class="flex items-end">
          <img th:src="${detailsResult.getImageUrl()}" th:alt="${detailsResult.getDisplayName()}"
               class="w-24 h-24 rounded-full profile-image object-cover mr-6"
               data-handle-error="true"
               data-placeholder="/img/profile-placeholder.svg">
          <div>
            <div class="flex items-center mb-2">
              <h1 class="text-4xl font-bold mr-3" th:text="${detailsResult.getDisplayName()}">인물
                이름</h1>
              <span th:text="${detailsResult.getCategoryDisplayName()}"
                    class="badge-category text-white text-sm px-3 py-1 rounded-full">카테고리</span>
            </div>
            <p class="text-gray-200 text-lg flex items-center">
              <i class="fas fa-quote-left text-sm opacity-50 mr-1"></i>
              <span th:text="${#strings.abbreviate(detailsResult.getBio(), 50)}">인물 소개 요약</span>
              <i class="fas fa-quote-right text-sm opacity-50 ml-1"></i>
              <button id="bio-toggle" class="ml-2 text-gray-300 hover:text-white transition-colors">
                <i class="fas fa-expand-alt text-sm"></i>
              </button>
            </p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- 왼쪽: 인물 정보 및 댓글 (2칸 차지) -->
    <div class="lg:col-span-2">
      <!-- 인물 평가 투표 섹션 -->
      <div
          th:replace="~{fragments/vote-section :: voteSection(${detailsResult}, ${current})}"></div>

      <!-- 댓글 섹션 부분 -->
      <div
          th:replace="~{fragments/comment-section :: commentSection(${detailsResult}, ${current})}"></div>
    </div>

    <!-- 오른쪽: 평판, 카테고리, 공유하기 (1칸 차지) -->
    <div class="lg:col-span-1">
      <!-- 페이지 우측 평판 통계 부분 -->
      <div
          th:replace="~{fragments/reputation-sidebar :: reputationSidebar(${detailsResult})}"></div>
      <script async
              src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1448769500494356"
              crossorigin="anonymous"></script>
      <ins class="adsbygoogle"
           style="display:block; text-align:center;"
           data-ad-layout="in-article"
           data-ad-format="fluid"
           data-ad-client="ca-pub-1448769500494356"
           data-ad-slot="2115046924"></ins>
      <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
      <!-- 페이지 우측 카테고리 섹션 -->
      <div th:replace="~{fragments/category-section :: categorySection(${detailsResult})}"></div>

      <!-- 공유하기 -->
      <div th:replace="~{fragments/share-section :: shareSection}"></div>

      <script async
              src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1448769500494356"
              crossorigin="anonymous"></script>
      <ins class="adsbygoogle"
           style="display:block; text-align:center;"
           data-ad-layout="in-article"
           data-ad-format="fluid"
           data-ad-client="ca-pub-1448769500494356"
           data-ad-slot="2115046924"></ins>
      <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
    </div>
  </div>


  <!-- Bio 모달 -->
  <div id="bio-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
    <div class="absolute inset-0 bg-black bg-opacity-70 backdrop-blur-sm"
         id="bio-modal-backdrop"></div>
    <div
        class="relative bg-gray-800 rounded-lg shadow-xl max-w-lg w-full mx-4 transform transition-all">
      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-semibold text-white"
              th:text="${detailsResult.getDisplayName()} + ' 소개'">인물 소개</h3>
          <button id="bio-modal-close" class="text-gray-400 hover:text-white">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="prose prose-invert max-w-none">
          <p class="text-gray-200 whitespace-pre-line" th:text="${detailsResult.getBio()}">전체 인물
            소개</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 스크립트 부분 -->
<th:block layout:fragment="script">
  <!-- 공통 유틸리티 스크립트 -->
  <script src="/js/utils/utils.js"></script>
  <script src="/js/utils/relative-time.js"></script>
  <script src="/js/utils/toast-manager.js"></script>
  <script src="/js/utils/scroll-to-top.js"></script>

  <!-- 외부 라이브러리 -->
  <script src="https://unpkg.com/infinite-scroll@4/dist/infinite-scroll.pkgd.min.js"></script>

  <!-- API 관련 스크립트 -->
  <script src="/js/apis/comment-api.js"></script>

  <!-- 댓글 관련 스크립트 -->
  <script src="/js/comment-fragments-handler.js"></script>
  <script src="/js/comment/comment-interactions-handler.js"></script>
  <script src="/js/comment/view-replies-handler.js"></script>
  <script src="/js/comment/add-reply-form-handler.js"></script>
  <script src="/js/create-comment-handler.js"></script>

  <!-- 페이지 특화 스크립트 -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // 인물 ID 가져오기
      const figureId = document.querySelector('.profile-header').getAttribute('data-figure-id');
      console.log('Figure detail page loaded with figure ID:', figureId);

      // 공유 버튼 기능
      document.querySelectorAll('[data-action^="share-"]').forEach(button => {
        button.addEventListener('click', function (e) {
          e.preventDefault();
          const action = this.getAttribute('data-action');
          const url = window.location.href;
          const title = document.title;

          switch (action) {
            case 'share-twitter':
              window.open(`https://twitter.com/intent/tweet?url=${encodeURIComponent(
                  url)}&text=${encodeURIComponent(title)}`, '_blank');
              break;
            case 'share-facebook':
              window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`,
                  '_blank');
              break;
            case 'share-link':
              navigator.clipboard.writeText(url).then(() => {
                alert('링크가 클립보드에 복사되었습니다.');
              });
              break;
          }
        });
      });

      // Bio 모달 관련 기능
      const bioToggle = document.getElementById('bio-toggle');
      const bioModal = document.getElementById('bio-modal');
      const bioModalClose = document.getElementById('bio-modal-close');
      const bioModalBackdrop = document.getElementById('bio-modal-backdrop');

      // 모달 열기
      if (bioToggle) {
        bioToggle.addEventListener('click', function () {
          bioModal.classList.remove('hidden');
          setTimeout(() => {
            bioModal.classList.add('show');
          }, 10);
          document.body.style.overflow = 'hidden'; // 스크롤 방지
        });
      }

      // 모달 닫기 함수
      const closeBioModal = function () {
        bioModal.classList.remove('show');
        setTimeout(() => {
          bioModal.classList.add('hidden');
          document.body.style.overflow = ''; // 스크롤 복원
        }, 300);
      };

      // 닫기 버튼 이벤트
      if (bioModalClose) {
        bioModalClose.addEventListener('click', closeBioModal);
      }

      // 배경 클릭 시 모달 닫기
      if (bioModalBackdrop) {
        bioModalBackdrop.addEventListener('click', closeBioModal);
      }

      // ESC 키 누를 때 모달 닫기
      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape' && !bioModal.classList.contains('hidden')) {
          closeBioModal();
        }
      });
    });
  </script>

  <!-- 모바일 최적화 스크립트 -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // 모바일 환경에서 댓글 UI 최적화
      function optimizeCommentUIForMobile() {
        if (window.innerWidth <= 640) {
          // 이미 로드된 댓글에 flex-wrap 적용
          document.querySelectorAll(
              '.comment-item .flex.items-center.text-sm.text-gray-500').forEach(el => {
            el.classList.add('flex-wrap');
            el.style.gap = '0.5rem';
          });

          // 버튼 간 간격 최적화
          document.querySelectorAll(
              '.like-button, .dislike-button, .add-reply-button, .view-replies-btn').forEach(
              btn => {
                btn.style.marginRight = '0.35rem';
              });
        }
      }

      // 초기 실행 및 화면 크기 변경 시 실행
      optimizeCommentUIForMobile();
      window.addEventListener('resize', optimizeCommentUIForMobile);

      // 댓글 로드 후에도 실행되도록 MutationObserver 설정
      const commentList = document.getElementById('comment-list');
      if (commentList) {
        const observer = new MutationObserver(function (mutations) {
          optimizeCommentUIForMobile();
        });

        observer.observe(commentList, {
          childList: true,
          subtree: true
        });
      }
    });
  </script>

  <!-- 로그인 체크 스크립트 -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // MutationObserver를 사용하여 동적으로 추가되는 답글 폼에 로그인 체크 적용
      const commentSection = document.getElementById('comment-section');
      if (commentSection) {
        const observer = new MutationObserver(function (mutations) {
          mutations.forEach(function (mutation) {
            if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
              // 동적으로 추가된 요소 중 로그인 체크가 필요한 요소 찾기
              mutation.addedNodes.forEach(function (node) {
                if (node.nodeType === 1) { // Element 노드인 경우만
                  const loginElements = node.querySelectorAll ?
                      node.querySelectorAll('.requires-login') : [];

                  if (loginElements.length > 0 && typeof window.openLoginModal === 'function') {
                    loginElements.forEach(element => {
                      // 이미 이벤트가 등록되어 있으면 건너뜀
                      if (element.hasAttribute('data-login-check-applied')) {
                        return;
                      }

                      element.setAttribute('data-login-check-applied', 'true');

                      const isLoggedIn = document.getElementById('userLoginStatus')?.value
                          === 'true';
                      if (!isLoggedIn) {
                        element.addEventListener('click', function (e) {
                          if (element.type === 'submit') {
                            e.preventDefault();
                          }
                          window.openLoginModal();
                        });

                        element.addEventListener('focus', function (e) {
                          window.openLoginModal();
                          element.blur();
                        });
                      }
                    });
                  }
                }
              });
            }
          });
        });

        // 모든 변화 관찰
        observer.observe(commentSection, {
          childList: true,
          subtree: true
        });
      }
    });
  </script>
</th:block>
</body>
<amp-auto-ads type="adsense"
              data-ad-client="ca-pub-1448769500494356">
</amp-auto-ads>
</html>