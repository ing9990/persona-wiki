<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">

<head>
  <title th:text="${detailsResult.getName()} + ' - 국민사형투표'">인물 상세</title>
  <script async
          src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1448769500494356"
          crossorigin="anonymous"></script>
  <meta name="description" th:content="${#strings.abbreviate(detailsResult.bio,15)}">

  <!-- CSS 파일 -->
  <link rel="stylesheet" href="/css/comment-reply.css">
  <link rel="stylesheet" href="/css/comment-style.css">
  <link rel="stylesheet" href="/css/fingure-detail.css">
  <link rel="stylesheet" href="/css/scroll-to-top.css">
  <link rel="stylesheet" href="/css/vote.css">
  <link rel="stylesheet" href="/css/comment-form.css">
  <link rel="stylesheet" href="/css/add-reply-form.css">

  <!-- 인라인 스타일 -->
  <style>
    /* 모바일 환경에서 댓글 버튼 레이아웃 최적화 */
    @media (max-width: 640px) {
      /* 댓글과 답글 버튼 그룹에 적용 */
      .comment-footer, .reply-footer,
      .like-button, .dislike-button, .add-reply-button,
      .view-replies-btn, .like-btn, .dislike-btn {
        margin-right: 0.5rem !important;
      }

      /* 버튼 그룹의 줄바꿈 처리 개선 */
      .flex.items-center.text-sm.text-gray-500,
      .reply-footer {
        flex-wrap: wrap;
        row-gap: 0.5rem;
        column-gap: 0.75rem;
      }

      /* 아이콘과 텍스트 간격 조정 */
      .far, .fa-regular {
        margin-right: 0.25rem !important;
      }

      /* 버튼 간 좌우 간격 조정 */
      .like-button, .dislike-button, .add-reply-button, .view-replies-btn {
        margin-right: 0.35rem;
      }
    }

    /* 모달 공통 스타일 */
    .modal-container {
      transition: opacity 0.3s ease;
      opacity: 0;
      z-index: 50;
    }

    .modal-container.show {
      opacity: 1;
    }

    /* Bio 버튼 스타일 */
    #bio-toggle {
      height: 24px;
      width: 24px;
      font-size: 0.9rem;
      transition: all 0.2s ease;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      position: relative;
    }

    #bio-toggle:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    #bio-toggle:active {
      transform: translateY(0);
    }

    #bio-toggle::after {
      content: '전체보기';
      position: absolute;
      top: -20px;
      left: 50%;
      transform: translateX(-50%) scale(0);
      background: rgba(30, 41, 59, 0.9);
      color: #e2e8f0;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      opacity: 0;
      pointer-events: none;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    #bio-toggle:hover::after {
      opacity: 1;
      transform: translateX(-50%) scale(1);
      top: -25px;
    }

    /* Bio 모달 스타일 */
    #bio-modal .modal-content {
      max-height: 80vh;
      overflow-y: auto;
    }

    @media (max-width: 640px) {
      #bio-modal .modal-content {
        max-height: 70vh;
        width: 90%;
      }
    }

    /* 프로필 이미지 호버 효과 */
    #profile-image-thumbnail {
      position: relative;
      transition: all 0.3s ease;
    }

    #profile-image-thumbnail::after {
      content: '\f00e'; /* fa-search-plus */
      font-family: 'Font Awesome 5 Free';
      font-weight: 900;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      background: rgba(0, 0, 0, 0.7);
      color: white;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease, transform 0.3s ease;
      font-size: 1.5rem;
    }

    #profile-image-thumbnail:hover::after {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }

    /* 모달 애니메이션 */
    @keyframes modalFadeIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .modal-animation {
      animation: modalFadeIn 0.3s ease forwards;
    }

    /* 이미지 모달 스타일 */
    #image-modal-content {
      box-shadow: 0 0 30px rgba(59, 130, 246, 0.3);
    }
  </style>
</head>

<body>
<div layout:fragment="content">
  <div id="comment-section" th:attr="data-figure-id=${detailsResult.id}"></div>

  <!-- 인물 프로필 헤더 -->
  <section class="profile-header mb-8 shadow-lg" th:attr="data-figure-id=${detailsResult.getId()}">
    <img th:src="${detailsResult.getCategoryImage()}" th:alt="${detailsResult.getName()}"
         class="profile-header-image">
    <div class="profile-header-content">
      <div class="flex items-end justify-between w-full">
        <div class="flex items-end">
          <img th:src="${detailsResult.getImageUrl()}" th:alt="${detailsResult.getName()}"
               class="w-24 h-24 rounded-full profile-image object-cover mr-6 cursor-pointer hover:ring-4 hover:ring-blue-400 transition-all transform hover:scale-105"
               data-handle-error="true"
               data-placeholder="/img/profile-placeholder.svg"
               id="profile-image-thumbnail"
               title="클릭하여 크게 보기">
          <div>
            <div class="flex items-center mb-2">
              <h1 class="text-4xl font-bold mr-3" th:text="${detailsResult.getName()}">인물 이름</h1>
              <span th:text="${detailsResult.getCategoryDisplayName()}"
                    class="badge-category text-white text-sm px-3 py-1 rounded-full">카테고리</span>
            </div>
            <p class="text-gray-200 text-lg flex items-center">
              <i class="fas fa-quote-left text-sm opacity-50 mr-1"></i>
              <span th:text="${#strings.abbreviate(detailsResult.getBio(), 50)}">인물 소개 요약</span>
              <i class="fas fa-quote-right text-sm opacity-50 ml-1"></i>
              <button id="bio-toggle"
                      class="ml-2 bg-gray-700 hover:bg-gray-600 text-blue-300 hover:text-blue-200 p-1 rounded-full transition-all shadow-sm flex items-center justify-center"
                      aria-label="전체 소개 보기">
                <i class="fas fa-info-circle"></i>
              </button>
            </p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- 왼쪽: 인물 정보 및 댓글 (2칸 차지) -->
    <div class="lg:col-span-2">
      <!-- 인물 평가 투표 섹션 -->
      <div
          th:replace="~{fragments/vote-section :: voteSection(${detailsResult}, ${current})}"></div>

      <!-- 댓글 섹션 부분 -->
      <div
          th:replace="~{fragments/comment-section :: commentSection(${detailsResult}, ${current})}"></div>
    </div>

    <!-- 오른쪽: 평판, 카테고리, 공유하기 (1칸 차지) -->
    <div class="lg:col-span-1">
      <!-- 페이지 우측 평판 통계 부분 -->
      <div
          th:replace="~{fragments/reputation-sidebar :: reputationSidebar(${detailsResult})}"></div>

      <!-- 페이지 우측 카테고리 섹션 -->
      <div th:replace="~{fragments/category-section :: categorySection(${detailsResult})}"></div>

      <!-- 공유하기 -->
      <div th:replace="~{fragments/share-section :: shareSection}"></div>
    </div>
  </div>

  <!-- Bio 모달 -->
  <div id="bio-modal" class="fixed inset-0 flex items-center justify-center hidden modal-container">
    <div class="absolute inset-0 bg-black bg-opacity-75 backdrop-blur-sm"
         id="bio-modal-backdrop"></div>
    <div
        class="relative bg-gray-800 rounded-lg shadow-xl max-w-lg w-full mx-4 transform transition-all border border-gray-700 modal-content modal-animation">
      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-semibold text-white" th:text="${detailsResult.getName()} + ' 소개'">
            인물 소개</h3>
          <button id="bio-modal-close"
                  class="text-gray-400 hover:text-white bg-gray-700 hover:bg-gray-600 p-1.5 rounded-full transition-all">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="prose prose-invert max-w-none">
          <div class="bg-gray-700 bg-opacity-50 p-4 rounded-lg border-l-4 border-blue-400">
            <p class="text-gray-200 whitespace-pre-line leading-relaxed"
               th:text="${detailsResult.getBio()}">전체 인물 소개</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 이미지 모달 -->
  <div id="image-modal"
       class="fixed inset-0 flex items-center justify-center hidden modal-container">
    <div class="absolute inset-0 bg-black bg-opacity-90 backdrop-blur-sm"
         id="image-modal-backdrop"></div>
    <div
        class="relative transform transition-all max-w-4xl w-full mx-4 flex flex-col items-center modal-animation">
      <div class="relative">
        <img id="image-modal-content" th:src="${detailsResult.getImageUrl()}"
             th:alt="${detailsResult.getName()}"
             class="max-w-full max-h-[80vh] object-contain rounded-lg shadow-2xl">
        <div class="absolute top-3 right-3">
          <button id="image-modal-close"
                  class="text-gray-300 hover:text-white bg-gray-800 bg-opacity-70 hover:bg-opacity-90 p-2 rounded-full transition-all shadow-lg">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="absolute -bottom-12 left-1/2 transform -translate-x-1/2 text-center">
          <h3 class="text-xl font-semibold text-white" th:text="${detailsResult.getName()}">인물
            이름</h3>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 스크립트 부분 -->
<th:block layout:fragment="script">
  <!-- 공통 유틸리티 스크립트 -->
  <script src="/js/utils/utils.js"></script>
  <script src="/js/utils/relative-time.js"></script>
  <script src="/js/utils/toast-manager.js"></script>
  <script src="/js/utils/scroll-to-top.js"></script>

  <!-- 외부 라이브러리 -->
  <script src="https://unpkg.com/infinite-scroll@4/dist/infinite-scroll.pkgd.min.js"></script>

  <!-- API 관련 스크립트 -->
  <script src="/js/apis/comment-api.js"></script>

  <!-- 댓글 관련 스크립트 -->
  <script src="/js/comment-fragments-handler.js"></script>
  <script src="/js/comment/comment-interactions-handler.js"></script>
  <script src="/js/comment/view-replies-handler.js"></script>
  <script src="/js/comment/add-reply-form-handler.js"></script>
  <script src="/js/create-comment-handler.js"></script>

  <!-- 페이지 특화 스크립트 -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // 인물 ID 가져오기
      const figureId = document.querySelector('.profile-header').getAttribute('data-figure-id');
      console.log('Figure detail page loaded with figure ID:', figureId);

      // 공유 버튼 기능
      document.querySelectorAll('[data-action^="share-"]').forEach(button => {
        button.addEventListener('click', function (e) {
          e.preventDefault();
          const action = this.getAttribute('data-action');
          const url = window.location.href;
          const title = document.title;

          switch (action) {
            case 'share-twitter':
              window.open(`https://twitter.com/intent/tweet?url=${encodeURIComponent(
                  url)}&text=${encodeURIComponent(title)}`, '_blank');
              break;
            case 'share-facebook':
              window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`,
                  '_blank');
              break;
            case 'share-link':
              navigator.clipboard.writeText(url).then(() => {
                alert('링크가 클립보드에 복사되었습니다.');
              });
              break;
          }
        });
      });

      // Bio 모달 관련 기능
      const bioToggle = document.getElementById('bio-toggle');
      const bioModal = document.getElementById('bio-modal');
      const bioModalClose = document.getElementById('bio-modal-close');
      const bioModalBackdrop = document.getElementById('bio-modal-backdrop');

      // 모달 열기
      if (bioToggle) {
        bioToggle.addEventListener('click', function () {
          bioModal.classList.remove('hidden');
          setTimeout(() => {
            bioModal.classList.add('show');
          }, 10);
          document.body.style.overflow = 'hidden'; // 스크롤 방지
        });
      }

      // 모달 닫기 함수
      const closeBioModal = function () {
        bioModal.classList.remove('show');
        setTimeout(() => {
          bioModal.classList.add('hidden');
          document.body.style.overflow = ''; // 스크롤 복원
        }, 300);
      };

      // 닫기 버튼 이벤트
      if (bioModalClose) {
        bioModalClose.addEventListener('click', closeBioModal);
      }

      // 배경 클릭 시 모달 닫기
      if (bioModalBackdrop) {
        bioModalBackdrop.addEventListener('click', closeBioModal);
      }

      // 이미지 모달 관련 기능
      const profileImage = document.getElementById('profile-image-thumbnail');
      const imageModal = document.getElementById('image-modal');
      const imageModalContent = document.getElementById('image-modal-content');
      const imageModalClose = document.getElementById('image-modal-close');
      const imageModalBackdrop = document.getElementById('image-modal-backdrop');

      // 이미지 모달 열기
      if (profileImage) {
        profileImage.addEventListener('click', function () {
          // 이미지 경로 가져오기
          const imageSrc = this.getAttribute('src');
          const imageAlt = this.getAttribute('alt');

          // 모달 이미지 설정
          imageModalContent.setAttribute('src', imageSrc);
          imageModalContent.setAttribute('alt', imageAlt);

          // 모달 표시
          imageModal.classList.remove('hidden');
          setTimeout(() => {
            imageModal.classList.add('show');
          }, 10);
          document.body.style.overflow = 'hidden'; // 스크롤 방지
        });
      }

      // 이미지 모달 닫기 함수
      const closeImageModal = function () {
        imageModal.classList.remove('show');
        setTimeout(() => {
          imageModal.classList.add('hidden');
          document.body.style.overflow = ''; // 스크롤 복원
        }, 300);
      };

      // 닫기 버튼 이벤트
      if (imageModalClose) {
        imageModalClose.addEventListener('click', closeImageModal);
      }

      // 배경 클릭 시 모달 닫기
      if (imageModalBackdrop) {
        imageModalBackdrop.addEventListener('click', closeImageModal);
      }

      // ESC 키 누를 때 모달 닫기
      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
          if (!bioModal.classList.contains('hidden')) {
            closeBioModal();
          }
          if (!imageModal.classList.contains('hidden')) {
            closeImageModal();
          }
        }
      });
    });
  </script>

  <!-- 모바일 최적화 스크립트 -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // 모바일 환경에서 댓글 UI 최적화
      function optimizeCommentUIForMobile() {
        if (window.innerWidth <= 640) {
          // 이미 로드된 댓글에 flex-wrap 적용
          document.querySelectorAll(
              '.comment-item .flex.items-center.text-sm.text-gray-500').forEach(el => {
            el.classList.add('flex-wrap');
            el.style.gap = '0.5rem';
          });

          // 버튼 간 간격 최적화
          document.querySelectorAll(
              '.like-button, .dislike-button, .add-reply-button, .view-replies-btn').forEach(
              btn => {
                btn.style.marginRight = '0.35rem';
              });
        }
      }

      // 초기 실행 및 화면 크기 변경 시 실행
      optimizeCommentUIForMobile();
      window.addEventListener('resize', optimizeCommentUIForMobile);

      // 댓글 로드 후에도 실행되도록 MutationObserver 설정
      const commentList = document.getElementById('comment-list');
      if (commentList) {
        const observer = new MutationObserver(function (mutations) {
          optimizeCommentUIForMobile();
        });

        observer.observe(commentList, {
          childList: true,
          subtree: true
        });
      }
    });
  </script>

  <!-- 로그인 체크 스크립트 -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // MutationObserver를 사용하여 동적으로 추가되는 답글 폼에 로그인 체크 적용
      const commentSection = document.getElementById('comment-section');
      if (commentSection) {
        const observer = new MutationObserver(function (mutations) {
          mutations.forEach(function (mutation) {
            if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
              // 동적으로 추가된 요소 중 로그인 체크가 필요한 요소 찾기
              mutation.addedNodes.forEach(function (node) {
                if (node.nodeType === 1) { // Element 노드인 경우만
                  const loginElements = node.querySelectorAll ?
                      node.querySelectorAll('.requires-login') : [];

                  if (loginElements.length > 0 && typeof window.openLoginModal === 'function') {
                    loginElements.forEach(element => {
                      // 이미 이벤트가 등록되어 있으면 건너뜀
                      if (element.hasAttribute('data-login-check-applied')) {
                        return;
                      }

                      element.setAttribute('data-login-check-applied', 'true');

                      const isLoggedIn = document.getElementById('userLoginStatus')?.value
                          === 'true';
                      if (!isLoggedIn) {
                        element.addEventListener('click', function (e) {
                          if (element.type === 'submit') {
                            e.preventDefault();
                          }
                          window.openLoginModal();
                        });

                        element.addEventListener('focus', function (e) {
                          window.openLoginModal();
                          element.blur();
                        });
                      }
                    });
                  }
                }
              });
            }
          });
        });

        // 모든 변화 관찰
        observer.observe(commentSection, {
          childList: true,
          subtree: true
        });
      }
    });
  </script>
</th:block>
</body>
<amp-auto-ads type="adsense"
              data-ad-client="ca-pub-1448769500494356">
</amp-auto-ads>
</html>