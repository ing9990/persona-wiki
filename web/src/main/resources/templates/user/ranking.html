<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}" lang="ko">
<head>
  <title>사용자 랭킹</title>
  <meta name="description" content="국민사형투표의 사용자 랭킹을 확인해보세요. 명성 점수에 따른 순위를 볼 수 있습니다.">
  <meta name="keywords" content="국민사형투표, 랭킹, 명성, 사용자 순위">

  <!-- 랭킹 페이지 전용 CSS -->
  <link rel="stylesheet" href="/css/ranking.css">
</head>

<body>
<main layout:fragment="content" class="py-6 md:py-12">
  <div class="container mx-auto px-4">
    <!-- 페이지 헤더 -->
    <div class="text-center mb-8 md:mb-12 ranking-header">
      <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-5">사용자 랭킹</h1>
      <p class="text-gray-600 max-w-2xl mx-auto mt-5"></p>
    </div>

    <!-- TOP 3 섹션 -->
    <div class="mb-12 top-ranks-container mt-5">
      <h2 class="text-xl font-semibold text-gray-700 mb-6 text-center"></h2>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
        <!-- 2등 -->
        <div th:if="${rankingData.topUsers.size() > 1}" th:with="user=${rankingData.topUsers[1]}"
             class="rank-card order-2 md:order-1 silver">
          <div
              class="relative flex flex-col items-center p-6 bg-gradient-to-br from-gray-100 to-gray-300 rounded-xl shadow-md transform hover:scale-105 transition-transform duration-300">
            <div
                class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-gray-200 text-gray-700 font-bold px-4 py-1 rounded-full shadow-md">
              <span class="mr-1" th:text="${user.rank}">2</span>
              <i class="fas fa-medal text-gray-400"></i>
            </div>

            <div
                class="w-24 h-24 rounded-full border-4 border-gray-300 shadow-inner overflow-hidden mb-4">
              <img th:src="${@layoutHelper.getProfileImageByString(user.profileImage)}"
                   alt="프로필 이미지" class="w-full h-full object-cover"
                   onerror="this.src='/img/profile-placeholder.svg';">
            </div>

            <h3 class="text-xl font-bold text-gray-800 mb-1" th:text="${user.nickname}">실버 사용자</h3>
            <div class="text-sm text-gray-600 mb-2">
              레벨 <span th:text="${@rankingHelper.calculateLevel(user.prestige).level}">5</span>
              (<span
                th:text="${@rankingHelper.getLevelTitle(@rankingHelper.calculateLevel(user.prestige).level)}">분석가</span>)
            </div>

            <div class="flex items-center text-lg font-bold text-gray-700">
              <i class="fas fa-star mr-2 text-yellow-500"></i>
              <span th:text="${#numbers.formatInteger(user.prestige, 0, 'COMMA')}">12,345</span>
              <span class="text-sm ml-1">점</span>
            </div>
          </div>
        </div>

        <!-- 1등 -->
        <div th:if="${!rankingData.topUsers.isEmpty()}" th:with="user=${rankingData.topUsers[0]}"
             class="rank-card order-1 md:order-2 gold">
          <div
              class="relative flex flex-col items-center p-8 bg-gradient-to-br from-yellow-50 to-yellow-200 rounded-xl shadow-lg transform hover:scale-105 transition-transform duration-300 -mt-4 md:-mt-8 z-10">
            <div
                class="absolute -top-5 left-1/2 transform -translate-x-1/2 bg-yellow-400 text-white font-bold px-6 py-2 rounded-full shadow-md">
              <span class="mr-1" th:text="${user.rank}">1</span>
              <i class="fas fa-crown text-yellow-600"></i>
            </div>

            <div
                class="w-32 h-32 rounded-full border-4 border-yellow-400 shadow-xl overflow-hidden mb-4 glow-effect">
              <img th:src="${@layoutHelper.getProfileImageByString(user.profileImage)}"
                   alt="프로필 이미지" class="w-full h-full object-cover"
                   onerror="this.src='/img/profile-placeholder.svg';">
            </div>

            <h3 class="text-2xl font-bold text-gray-800 mb-1" th:text="${user.nickname}">골드 사용자</h3>
            <div class="text-sm text-gray-600 mb-2">
              레벨 <span th:text="${@rankingHelper.calculateLevel(user.prestige).level}">8</span>
              (<span
                th:text="${@rankingHelper.getLevelTitle(@rankingHelper.calculateLevel(user.prestige).level)}">대가</span>)
            </div>

            <div class="flex items-center text-xl font-bold text-gray-800">
              <i class="fas fa-star mr-2 text-yellow-500"></i>
              <span th:text="${#numbers.formatInteger(user.prestige, 0, 'COMMA')}">45,678</span>
              <span class="text-sm ml-1">점</span>
            </div>
          </div>
        </div>

        <!-- 3등 -->
        <div th:if="${rankingData.topUsers.size() > 2}" th:with="user=${rankingData.topUsers[2]}"
             class="rank-card order-3 bronze">
          <div
              class="relative flex flex-col items-center p-6 bg-gradient-to-br from-orange-50 to-orange-200 rounded-xl shadow-md transform hover:scale-105 transition-transform duration-300">
            <div
                class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-orange-300 text-white font-bold px-4 py-1 rounded-full shadow-md">
              <span class="mr-1" th:text="${user.rank}">3</span>
              <i class="fas fa-medal text-orange-500"></i>
            </div>

            <div
                class="w-24 h-24 rounded-full border-4 border-orange-300 shadow-inner overflow-hidden mb-4">
              <img th:src="${@layoutHelper.getProfileImageByString(user.profileImage)}"
                   alt="프로필 이미지" class="w-full h-full object-cover"
                   onerror="this.src='/img/profile-placeholder.svg';">
            </div>

            <h3 class="text-xl font-bold text-gray-800 mb-1" th:text="${user.nickname}">브론즈 사용자</h3>
            <div class="text-sm text-gray-600 mb-2">
              레벨 <span th:text="${@rankingHelper.calculateLevel(user.prestige).level}">3</span>
              (<span
                th:text="${@rankingHelper.getLevelTitle(@rankingHelper.calculateLevel(user.prestige).level)}">평론가</span>)
            </div>

            <div class="flex items-center text-lg font-bold text-gray-700">
              <i class="fas fa-star mr-2 text-yellow-500"></i>
              <span th:text="${#numbers.formatInteger(user.prestige, 0, 'COMMA')}">8,765</span>
              <span class="text-sm ml-1">점</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 나의 랭킹 -->
    <div th:if="${currentUserRank != null}" class="mb-8 my-rank-container">
      <div class="bg-indigo-50 border-l-4 border-indigo-500 p-4 rounded-lg shadow-md">
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <div class="text-3xl font-bold text-indigo-600 mr-4" th:text="${currentUserRank.rank}">
              721
            </div>
            <div class="flex items-center">
              <div class="w-12 h-12 rounded-full overflow-hidden mr-3">
                <img th:src="${@layoutHelper.getProfileImageByString(currentUserRank.profileImage)}"
                     alt="내 프로필" class="w-full h-full object-cover"
                     onerror="this.src='/img/profile-placeholder.svg';">
              </div>
              <div>
                <div class="font-bold text-gray-800" th:text="${currentUserRank.nickname}">나의 닉네임
                </div>
                <div class="text-sm text-gray-600">
                  레벨 <span
                    th:text="${@rankingHelper.calculateLevel(currentUserRank.prestige).level}">2</span>
                  (<span
                    th:text="${@rankingHelper.getLevelTitle(@rankingHelper.calculateLevel(currentUserRank.prestige).level)}">관찰자</span>)
                </div>
              </div>
            </div>
          </div>

          <div class="flex items-center">
            <i class="fas fa-star mr-2 text-yellow-500"></i>
            <span class="font-bold"
                  th:text="${#numbers.formatInteger(currentUserRank.prestige, 0, 'COMMA')}">2,345</span>
            <span class="text-sm ml-1">점</span>
          </div>
        </div>
      </div>
    </div>

    <!-- 랭킹 목록 -->
    <div class="bg-white rounded-xl shadow-md overflow-hidden">
      <div class="px-4 py-5 sm:px-6 border-b border-gray-200 bg-gray-50">
        <h3 class="text-lg font-semibold text-gray-800">전체 랭킹</h3>
        <p class="text-sm text-gray-500 mt-1">현재 총 <span
            th:text="${rankingData.totalUsers}">1,234</span>명의 사용자가 있습니다</p>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
          <tr>
            <th scope="col"
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              순위
            </th>
            <th scope="col"
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              사용자
            </th>
            <th scope="col"
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              레벨
            </th>
            <th scope="col"
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              명성 점수
            </th>
            <th scope="col"
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              한줄 소개
            </th>
          </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
          <!-- 랭킹 목록 -->
          <tr th:each="user : ${rankingData.rankings}"
              class="hover:bg-gray-50 transition-colors"
              th:classappend="${currentUserRank != null && currentUserRank.userId == user.userId ? 'bg-indigo-50' : ''}">
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm font-medium text-gray-900" th:text="${user.rank}">4</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <div class="flex-shrink-0 h-10 w-10 rounded-full overflow-hidden">
                  <img th:src="${@layoutHelper.getProfileImageByString(user.profileImage)}" alt=""
                       class="h-10 w-10 object-cover"
                       onerror="this.src='/img/profile-placeholder.svg';">
                </div>
                <div class="ml-4">
                  <div class="text-sm font-medium text-gray-900" th:text="${user.nickname}">사용자 이름
                  </div>
                </div>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900">
                <span th:text="${@rankingHelper.calculateLevel(user.prestige).level}">3</span>
                (<span
                  th:text="${@rankingHelper.getLevelTitle(@rankingHelper.calculateLevel(user.prestige).level)}">평론가</span>)
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center text-sm text-gray-900">
                <i class="fas fa-star mr-2 text-yellow-500"></i>
                <span th:text="${#numbers.formatInteger(user.prestige, 0, 'COMMA')}">7,890</span>
              </div>
            </td>
            <td class="px-6 py-4">
              <div class="text-sm text-gray-500 truncate max-w-xs"
                   th:text="${#strings.isEmpty(user.bio) ? '한줄 소개가 없습니다.' : user.bio}">
                사용자 한줄 소개 텍스트가 들어갑니다...
              </div>
            </td>
          </tr>

          <!-- 데이터가 없을 경우 -->
          <tr th:if="${rankingData.rankings.isEmpty()}">
            <td colspan="5" class="px-6 py-8 text-center text-gray-500">
              <div class="flex flex-col items-center">
                <i class="fas fa-users text-gray-300 text-5xl mb-4"></i>
                <p>표시할 사용자가 없습니다.</p>
              </div>
            </td>
          </tr>
          </tbody>
        </table>
      </div>

      <!-- 페이지네이션 -->
      <div class="px-4 py-3 bg-gray-50 border-t border-gray-200 sm:px-6"
           th:if="${rankingData.totalPages > 1}">
        <div class="flex-1 flex justify-between sm:justify-end">
          <a th:href="@{/ranking(page=${rankingData.currentPage - 1})}"
             th:class="${rankingData.currentPage == 0 ? 'opacity-50 cursor-not-allowed' : ''}"
             th:classappend="${rankingData.currentPage == 0 ? 'pointer-events-none' : ''}"
             class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
            이전
          </a>

          <div class="hidden md:flex mx-2 items-center">
              <span th:each="i : ${#numbers.sequence(1, rankingData.totalPages)}"
                    th:if="${i <= 5 || i > rankingData.totalPages - 5 || (i > rankingData.currentPage - 3 && i < rankingData.currentPage + 3)}">
                <a th:href="@{/ranking(page=${i - 1})}" th:text="${i}"
                   th:class="${rankingData.currentPage == i - 1 ? 'bg-indigo-100 text-indigo-700' : 'text-gray-700 hover:bg-gray-50'}"
                   class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md mx-1">1</a>
                   
                <span
                    th:if="${i == 5 && rankingData.totalPages > 10 && rankingData.currentPage >= 7}"
                    class="px-2">...</span>
                <span
                    th:if="${i == rankingData.totalPages - 5 && rankingData.totalPages > 10 && rankingData.currentPage < rankingData.totalPages - 7}"
                    class="px-2">...</span>
              </span>
          </div>

          <a th:href="@{/ranking(page=${rankingData.currentPage + 1})}"
             th:class="${rankingData.currentPage >= rankingData.totalPages - 1 ? 'opacity-50 cursor-not-allowed' : ''}"
             th:classappend="${rankingData.currentPage >= rankingData.totalPages - 1 ? 'pointer-events-none' : ''}"
             class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
            다음
          </a>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- 랭킹 페이지 전용 JS -->
<script layout:fragment="script">
  document.addEventListener('DOMContentLoaded', function () {
    // 현재 사용자 행으로 스크롤
    const currentUserRow = document.querySelector('tbody tr.bg-indigo-50');

    if (currentUserRow) {
      // 0.5초 후 스크롤 (페이지 로드 후)
      setTimeout(() => {
        const offset = currentUserRow.offsetTop - window.innerHeight / 2;

        // 부드러운 스크롤 적용
        window.scrollTo({
          top: offset,
          behavior: 'smooth'
        });

        // 잠깐 동안 행 강조
        currentUserRow.classList.add('transition-all', 'duration-500');
        currentUserRow.style.backgroundColor = 'rgba(99, 102, 241, 0.2)';

        setTimeout(() => {
          currentUserRow.style.backgroundColor = '';
        }, 1500);
      }, 500);
    }

    // 프로필 이미지 호버 효과
    const profileImages = document.querySelectorAll('table img');
    profileImages.forEach(img => {
      img.classList.add('transition-transform', 'duration-300');

      img.addEventListener('mouseenter', function () {
        this.style.transform = 'scale(1.2)';
      });

      img.addEventListener('mouseleave', function () {
        this.style.transform = 'scale(1)';
      });
    });

    // 상위 랭크 카드 애니메이션
    const rankCards = document.querySelectorAll('.rank-card');
    rankCards.forEach((card, index) => {
      card.style.opacity = '0';
      card.style.transform = 'translateY(20px)';

      setTimeout(() => {
        card.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
        card.style.opacity = '1';
        card.style.transform = 'translateY(0)';
      }, 100 + (index * 200));
    });
  });
</script>

<!-- 랭킹 페이지 스타일 -->
<style layout:fragment="css">
  /* 애니메이션 키프레임 */
  @keyframes float {
    0% {
      transform: translateY(0px);
    }
    50% {
      transform: translateY(-10px);
    }
    100% {
      transform: translateY(0px);
    }
  }

  @keyframes pulse {
    0% {
      box-shadow: 0 0 0 0 rgba(217, 119, 6, 0.4);
    }
    70% {
      box-shadow: 0 0 0 15px rgba(217, 119, 6, 0);
    }
    100% {
      box-shadow: 0 0 0 0 rgba(217, 119, 6, 0);
    }
  }

  @keyframes shine {
    0% {
      background-position: -100px;
    }
    40%, 100% {
      background-position: 300px;
    }
  }

  /* 1등(Gold) 스타일 */
  .rank-card.gold .glow-effect {
    animation: pulse 2s infinite;
    box-shadow: 0 0 15px rgba(217, 119, 6, 0.6);
  }

  /* 아이콘 효과 */
  .fa-crown {
    animation: float 3s ease-in-out infinite;
  }

  .fa-medal {
    animation: float 2.5s ease-in-out infinite;
  }

  /* 나의 랭킹 컨테이너 */
  .my-rank-container {
    position: relative;
  }

  .my-rank-container::before {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border-radius: 0.5rem;
    content: '';
    background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.1), transparent);
    background-size: 200% 100%;
    animation: shine 3s infinite;
  }

  /* 현재 사용자 행 하이라이트 */
  table tbody tr.bg-indigo-50 {
    position: relative;
  }

  table tbody tr.bg-indigo-50::after {
    content: '현재 회원';
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 0.75rem;
    color: #6366F1;
    font-weight: bold;
    padding: 2px 8px;
    border-radius: 9999px;
    background-color: rgba(99, 102, 241, 0.1);
  }

  /* 반응형 스타일 */
  @media (max-width: 768px) {
    /* 모바일에서는 카드를 쌓아서 표시 */
    .rank-card.gold {
      order: 1 !important;
    }

    .rank-card.silver {
      order: 2 !important;
    }

    .rank-card.bronze {
      order: 3 !important;
    }

    /* 모바일에서 테이블 최적화 */
    table th:nth-child(3),
    table td:nth-child(3),
    table th:nth-child(5),
    table td:nth-child(5) {
      display: none;
    }

    /* 모바일에서 현재 회원 표시 제거 */
    table tbody tr.bg-indigo-50::after {
      content: none;
    }

    /* 모바일에서 현재 회원 행 강조 */
    table tbody tr.bg-indigo-50 {
      border-left: 3px solid #6366F1;
    }
  }
</style>
</body>
</html>
