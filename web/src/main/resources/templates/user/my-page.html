<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">

<head>
  <title>내 정보 - 국민사형투표</title>
  <meta name="description" content="내 계정 정보를 관리할 수 있습니다.">

  <!-- 마이페이지 전용 스타일 -->
  <style>
    .profile-section {
      animation: fadeIn 0.5s ease-in-out;
    }

    .profile-image-container {
      position: relative;
      width: 150px;
      height: 150px;
      margin: 0 auto;
    }

    .profile-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
      border: 4px solid white;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .profile-image-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      border-radius: 50%;
      opacity: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: opacity 0.3s ease;
      cursor: pointer;
    }

    .profile-image-container:hover .profile-image-overlay {
      opacity: 1;
    }

    .profile-image-text {
      color: white;
      font-size: 0.875rem;
      font-weight: 500;
    }

    .info-card {
      background-color: white;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .info-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
    }

    .edit-button {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.5rem;
      font-size: 0.875rem;
      color: #6366F1;
      background-color: #EEF2FF;
      border-radius: 0.25rem;
      transition: all 0.2s ease;
    }

    .edit-button:hover {
      background-color: #C7D2FE;
    }

    .withdraw-button {
      background-color: #FEE2E2;
      color: #DC2626;
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      font-weight: 500;
      transition: all 0.2s ease;
      border: none;
      cursor: pointer;
    }

    .withdraw-button:hover {
      background-color: #FCA5A5;
    }

    /* 모달 스타일 */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 50;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .modal-backdrop.active {
      opacity: 1;
      pointer-events: auto;
    }

    .modal-content {
      background-color: white;
      border-radius: 0.5rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      width: 95%;
      max-width: 500px;
      padding: 1.5rem;
      transform: scale(0.95);
      opacity: 0;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }

    .modal-backdrop.active .modal-content {
      transform: scale(1);
      opacity: 1;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>

<body>
<div layout:fragment="content">
  <!-- 페이지 헤더 -->
  <section class="mb-8">
    <div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-lg shadow-md p-6">
      <h1 class="text-3xl font-bold mb-2">내 정보</h1>
      <p class="text-lg text-indigo-100">회원 정보를 확인하고 관리할 수 있습니다.</p>
    </div>
  </section>

  <!-- 알림 메시지 (성공/에러) -->
  <div th:if="${success}"
       class="mb-6 p-4 bg-green-100 border border-green-200 text-green-700 rounded-md">
    <div class="flex">
      <i class="fas fa-check-circle text-green-500 mr-3"></i>
      <span th:text="${success}">성공 메시지</span>
    </div>
  </div>

  <div th:if="${error}" class="mb-6 p-4 bg-red-100 border border-red-200 text-red-700 rounded-md">
    <div class="flex">
      <i class="fas fa-exclamation-circle text-red-500 mr-3"></i>
      <span th:text="${error}">오류 메시지</span>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- 왼쪽: 프로필 정보 -->
    <div class="lg:col-span-2 space-y-6">
      <!-- 프로필 사진 섹션 -->
      <div class="info-card profile-section">
        <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
          <i class="fas fa-user-circle text-indigo-500 mr-2"></i>
          <span>회원 정보</span>
        </h2>

        <div class="flex flex-col md:flex-row items-center">
          <!-- 프로필 이미지 -->
          <div class="profile-image-container mb-6 md:mb-0">
            <img
                th:src="${@layoutHelper.getProfileImageByString(user.image)}"
                alt="프로필 이미지" class="profile-image"
                onerror="this.src='/img/profile-placeholder.svg'">
            <div class="profile-image-overlay" id="profileImageTrigger">
              <span class="profile-image-text">
                <i class="fas fa-camera mr-1"></i> 사진 변경
              </span>
            </div>
          </div>

          <!-- 프로필 정보 -->
          <div class="md:ml-8 flex-grow text-center md:text-left">
            <div class="mb-4">
              <div class="flex items-center justify-center md:justify-start">
                <h3 class="text-2xl font-bold text-gray-800 mr-2" th:text="${user.nickname}">사용자
                  이름</h3>
                <button id="editNicknameTrigger" class="edit-button">
                  <i class="fas fa-pencil-alt mr-1"></i> 수정
                </button>
              </div>
              <p class="text-gray-600 mt-1">가입일: <span
                  th:text="${#temporals.format(user.createdAt, 'yyyy년 MM월 dd일')}">2023년 01월 01일</span>
              </p>
            </div>

            <div class="mb-4">
              <span
                  class="inline-block bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-sm">
                <i class="fas fa-sign-in-alt mr-1"></i>
                <span th:text="${user.provider}">소셜 로그인 제공자</span> 계정으로 로그인
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- 활동 요약 섹션 -->
      <div class="info-card profile-section">
        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
          <i class="fas fa-chart-line text-indigo-500 mr-2"></i>
          <span>활동 요약</span>
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="bg-gray-50 p-4 rounded-lg text-center">
            <div class="text-3xl font-bold text-indigo-600 mb-1">0</div>
            <div class="text-sm text-gray-600">작성한 댓글</div>
          </div>
          <div class="bg-gray-50 p-4 rounded-lg text-center">
            <div class="text-3xl font-bold text-green-600 mb-1">0</div>
            <div class="text-sm text-gray-600">참여한 투표</div>
          </div>
          <div class="bg-gray-50 p-4 rounded-lg text-center">
            <div class="text-3xl font-bold text-blue-600 mb-1">0</div>
            <div class="text-sm text-gray-600">추가한 인물</div>
          </div>
        </div>

        <div class="mt-6 text-center">
          <a href="/activity"
             class="inline-block bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition">
            <i class="fas fa-history mr-1"></i> 모든 활동 보기
          </a>
        </div>
      </div>
    </div>

    <!-- 오른쪽: 사이드바 -->
    <div class="space-y-6">
      <!-- 최근 활동 -->
      <div class="info-card profile-section">
        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
          <i class="fas fa-history text-indigo-500 mr-2"></i>
          <span>최근 활동</span>
        </h2>

        <!-- 활동이 없는 경우 -->
        <div class="text-center py-4 text-gray-500">
          <i class="fas fa-info-circle text-xl mb-2"></i>
          <p>아직 활동 내역이 없습니다.</p>
        </div>

        <div class="mt-4 text-center">
          <a href="/activity" class="text-indigo-600 hover:text-indigo-800 transition">
            모든 활동 보기 <i class="fas fa-arrow-right ml-1"></i>
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- 프로필 이미지 변경 모달 -->
  <div id="profileImageModal" class="modal-backdrop">
    <div class="modal-content">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-gray-800">프로필 사진 변경</h3>
        <button class="modal-close text-gray-500 hover:text-gray-700">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <form action="/me/profile" method="delete">
        <div class="text-right space-x-3">
          <button type="button"
                  class="modal-close px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition">
            취소
          </button>
          <button type="submit"
                  class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">
            프로필 사진 삭제하기
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- 닉네임 변경 모달 -->
  <div id="editNicknameModal" class="modal-backdrop">
    <div class="modal-content">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-gray-800">닉네임 변경</h3>
        <button class="modal-close text-gray-500 hover:text-gray-700">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <form action="/me/update-nickname" method="post">
        <div class="mb-4">
          <label for="nickname" class="block text-sm font-medium text-gray-700 mb-1">
            새 닉네임
          </label>
          <input type="text" id="nickname" name="nickname" required
                 th:value="${user.nickname}"
                 class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
          <p class="mt-1 text-xs text-gray-500">다른 사용자에게 표시될 이름입니다.</p>
        </div>

        <div class="text-right space-x-3">
          <button type="button"
                  class="modal-close px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition">
            취소
          </button>
          <button type="submit"
                  class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">
            변경하기
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- 회원 탈퇴 확인 모달 -->
  <div id="withdrawModal" class="modal-backdrop">
    <div class="modal-content">

      <form action="/me/withdraw" method="post">
        <div class="text-right space-x-3">
          <button type="button"
                  class="modal-close px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition">
            취소
          </button>
          <button type="submit"
                  class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition">
            탈퇴하기
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- 페이지 자바스크립트 -->
<th:block layout:fragment="script">
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // 모달 요소들
      const profileImageModal = document.getElementById('profileImageModal');
      const editNicknameModal = document.getElementById('editNicknameModal');
      const withdrawModal = document.getElementById('withdrawModal');

      // 모달 트리거 버튼들
      const profileImageTrigger = document.getElementById('profileImageTrigger');
      const editNicknameTrigger = document.getElementById('editNicknameTrigger');
      const withdrawTrigger = document.getElementById('withdrawTrigger');

      // 모달 닫기 버튼들
      const closeButtons = document.querySelectorAll('.modal-close');

      // 모달 열기 함수
      function openModal(modal) {
        modal.classList.add('active');
        document.body.style.overflow = 'hidden'; // 배경 스크롤 방지
      }

      // 모달 닫기 함수
      function closeModal(modal) {
        modal.classList.remove('active');
        document.body.style.overflow = ''; // 배경 스크롤 복원
      }

      // 모든 모달 닫기
      function closeAllModals() {
        const modals = document.querySelectorAll('.modal-backdrop');
        modals.forEach(modal => closeModal(modal));
      }

      // 트리거 버튼에 이벤트 리스너 추가
      if (profileImageTrigger) {
        profileImageTrigger.addEventListener('click', () => openModal(profileImageModal));
      }

      if (editNicknameTrigger) {
        editNicknameTrigger.addEventListener('click', () => openModal(editNicknameModal));
      }

      if (withdrawTrigger) {
        withdrawTrigger.addEventListener('click', () => openModal(withdrawModal));
      }

      // 닫기 버튼에 이벤트 리스너 추가
      closeButtons.forEach(button => {
        button.addEventListener('click', () => {
          const modal = button.closest('.modal-backdrop');
          closeModal(modal);
        });
      });

      // 모달 외부 클릭 시 닫기
      document.querySelectorAll('.modal-backdrop').forEach(modal => {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            closeModal(modal);
          }
        });
      });

      // ESC 키로 모달 닫기
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeAllModals();
        }
      });
    });
  </script>
</th:block>
</body>
</html>