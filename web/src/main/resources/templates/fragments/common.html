<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <!-- 페이지 제목과 메타 태그 프래그먼트 -->
  <th:block th:fragment="head(title, description)">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <!-- 기본 메타 태그 -->
    <meta name="description" th:content="${description ?: '국민사형투표 - 공적인 인물들에 대한 정보와 평가를 공유하는 플랫폼'}">
    <meta name="keywords" content="국민사형투표, 공인, 유명인, 정치인, 연예인, 유튜버, 의견공유, 평가">
    <meta name="author" content="국민사형투표">
    <meta name="robots" content="index, follow">
    <meta name="canonical" th:href="${canonicalUrl ?: 'https://국민사형투표.com'}"
          href="https://국민사형투표.com"/>

    <!-- 오픈 그래프 메타 태그 (소셜 미디어 공유용) -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://국민사형투표.com">
    <meta property="og:site_name" content="국민사형투표">
    <meta property="og:title" th:content="${title ?: '국민사형투표'}">
    <meta property="og:description" th:content="${description ?: '공적인 인물들에 대한 정보와 평가를 공유하는 플랫폼'}">
    <meta property="og:image" content="https://국민사형투표.com/img/og-image.jpg">
    <meta property="og:locale" content="ko_KR">

    <!-- 트위터 카드 메타 태그 -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" th:content="${title ?: '국민사형투표'}">
    <meta name="twitter:description" th:content="${description ?: '공적인 인물들에 대한 정보와 평가를 공유하는 플랫폼'}">
    <meta name="twitter:image" content="https://국민사형투표.com/img/og-image.jpg">

    <!-- 모바일 및 애플 기기 최적화 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="국민사형투표">
    <meta name="theme-color" content="#6366F1">

    <!-- 아이콘 및 매니페스트 -->
    <link rel="icon" href="/favicon.ico" sizes="32x32">

    <!-- CSS 최적화 로드 -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
          rel="stylesheet">
    <link rel="stylesheet" href="/css/common.css">

    <!-- Font Awesome 비동기 로드 -->
    <link rel="preload"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
          as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript>
      <link rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    </noscript>

    <!-- 핵심 이미지 프리로딩 -->
    <link rel="preload" th:href="${@layoutHelper.placeHolderAddress}" as="image" type="image/png">

    <!-- Alpine.js 지연 로드 -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.12.3/dist/cdn.min.js"></script>

    <!-- 구글 애드센스 -->
    <script async
            src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1448769500494356"
            crossorigin="anonymous"></script>

    <title th:text="${title} ? ${title} + ' - 국민사형투표' : '국민사형투표'">국민사형투표</title>
  </th:block>

  <!-- 공통 CSS와 스크립트 프래그먼트 -->
  <th:block th:fragment="css-and-scripts">
    <!-- 공통 자바스크립트 -->
    <script src="/js/utils/common-utils.js"></script>
  </th:block>
</head>
<body>
<!-- 헤더 네비게이션 프래그먼트 -->
<header th:fragment="header" class="gradient-bg text-white shadow-md">
  <div class="container mx-auto px-4 py-4">
    <nav class="flex flex-col md:flex-row md:justify-between md:items-center" aria-label="메인 네비게이션">
      <!-- (1) 로고 + 모바일 영역 -->
      <div class="w-full md:w-auto flex justify-between items-center">
        <!-- 로고 -->
        <a href="/" class="text-xl md:text-2xl font-bold flex items-center" aria-label="홈으로 이동">
          <img src="/img/logo.svg" alt="국민사형투표 아이콘" class="h-8 mr-2">
          국민사형투표
        </a>

        <!-- (A) 모바일용 우측 영역 -->
        <div class="flex items-center">
          <!-- 비로그인: 모바일에서만 (md:hidden) 햄버거 + 로그인 아이콘 표시 -->
          <th:block th:unless="${@layoutHelper.isLoggedIn(session.user)}">
            <div class="md:hidden flex items-center">
              <!-- 햄버거 버튼 (모바일 메뉴 열기) -->
              <button
                  id="mobileMenuButton"
                  class="text-white focus:outline-none mr-3"
                  aria-label="메뉴 열기"
                  aria-controls="mobileMenu"
                  aria-expanded="false">
                <i class="fas fa-bars text-xl" aria-hidden="true"></i>
              </button>

              <!-- 로그인 아이콘 (/login 이동) -->
              <a href="/login"
                 class="text-white focus:outline-none"
                 aria-label="로그인">
                <i class="fas fa-sign-in-alt text-xl" aria-hidden="true"></i>
              </a>
            </div>
          </th:block>

          <!-- 로그인: 모바일에서만 프로필 아이콘 (드롭다운) -->
          <th:block th:if="${@layoutHelper.isLoggedIn(session.user)}">
            <div class="relative md:hidden" x-data="{ openMobileProfile: false }">
              <button
                  @click="openMobileProfile = !openMobileProfile"
                  class="flex items-center focus:outline-none ml-2"
                  aria-haspopup="true"
                  aria-expanded="false">
                <img th:src="${@layoutHelper.getProfileImage(session.user)}"
                     alt="프로필 이미지"
                     class="w-8 h-8 rounded-full border-2 border-white object-cover"
                     onerror="this.src='/img/profile-placeholder.svg';">
              </button>

              <!-- (A-1) 모바일 프로필 드롭다운 -->
              <div
                  x-show="openMobileProfile"
                  @click.away="openMobileProfile = false"
                  x-transition:enter="transition ease-out duration-200"
                  x-transition:enter-start="opacity-0 scale-95"
                  x-transition:enter-end="opacity-100 scale-100"
                  class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50"
                  x-cloak
              >
                <a href="/figures"
                   class="block px-4 py-2 text-sm text-gray-700 hover:bg-indigo-100">
                  <i class="fas fa-users mr-2"></i> 인물 목록
                </a>
                <a href="/add-figure"
                   class="block px-4 py-2 text-sm text-gray-700 hover:bg-indigo-100">
                  <i class="fas fa-plus-circle mr-2"></i> 인물 추가
                </a>
                <a href="/me"
                   class="block px-4 py-2 text-sm text-gray-700 hover:bg-indigo-100">
                  <i class="fas fa-user mr-2"></i> 내 정보
                </a>
                <div class="border-t border-gray-100 my-1"></div>
                <a href="/auth/logout"
                   class="block px-4 py-2 text-sm text-red-600 hover:bg-indigo-100">
                  <i class="fas fa-sign-out-alt mr-2"></i> 로그아웃
                </a>
              </div>
            </div>
          </th:block>
        </div>
      </div>

      <!-- (2) 검색 영역 (PC/모바일 공용) -->
      <div class="w-full mt-3 md:mt-0 md:flex-grow md:max-w-xl md:mx-auto relative"
           x-data="CommonUtils.search.createSearchHandler()">
        <form action="/search" method="get" class="w-full" @submit="submitSearch" role="search">
          <label for="search-input" class="sr-only">인물 검색</label>
          <div class="relative">
            <input
                id="search-input"
                type="text"
                name="query"
                placeholder="인물 검색..."
                x-model="searchQuery"
                @input="updateSuggestions"
                @focus="showSuggestions = true"
                @click.away="showSuggestions = false"
                @keydown="handleKeydown"
                class="w-full py-2 px-4 rounded-full bg-white bg-opacity-20 text-white placeholder-white placeholder-opacity-70 focus:outline-none focus:ring-2 focus:ring-white"
                aria-label="인물 검색"
                autocomplete="off">
            <button type="submit"
                    class="absolute right-3 top-1/2 transform -translate-y-1/2"
                    aria-label="검색">
              <i class="fas fa-search" aria-hidden="true"></i>
            </button>
          </div>

          <!-- 검색 추천 목록 (Alpine.js) -->
          <div
              x-show="showSuggestions && suggestions.length > 0"
              x-transition:enter="transition ease-out duration-200"
              x-transition:enter-start="opacity-0 transform scale-95"
              x-transition:enter-end="opacity-100 transform scale-100"
              x-cloak
              class="absolute z-50 mt-1 w-full bg-white rounded-lg shadow-lg overflow-hidden"
              role="listbox"
              aria-label="검색 추천">
            <ul class="max-h-60 overflow-y-auto py-2">
              <template x-for="(suggestion, index) in suggestions" :key="suggestion.id">
                <li
                    @mousedown.prevent="selectSuggestion(suggestion)"
                    class="px-4 py-2 hover:bg-indigo-50 cursor-pointer transition-colors flex items-center"
                    :class="{'bg-indigo-50': selectedIndex === index}"
                    role="option"
                    :aria-selected="selectedIndex === index">
                  <div class="w-8 h-8 overflow-hidden rounded-full mr-3 bg-gray-200 flex-shrink-0">
                    <img
                        :src="suggestion.imageUrl"
                        :alt="suggestion.name + ' 프로필'"
                        class="w-full h-full object-cover"
                        onerror="this.src='/img/profile-placeholder.svg'">
                  </div>
                  <div class="flex-grow">
                    <div class="font-medium text-gray-800" x-text="suggestion.name"></div>
                    <div class="text-xs text-gray-500" x-text="suggestion.categoryName"></div>
                  </div>
                  <span class="text-indigo-500 text-xs ml-2">
                      <i class="fas fa-external-link-alt" aria-hidden="true"></i>
                    </span>
                </li>
              </template>
            </ul>
          </div>
        </form>
      </div>

      <!-- (3) 메인 메뉴 (PC 전용) -->
      <div class="hidden md:flex items-center space-x-4">
        <a href="/figures" class="text-white hover:text-indigo-100 transition" aria-label="인물 목록">
          <i class="fas fa-users mr-1" aria-hidden="true"></i>
          <span>인물</span>
        </a>

        <!-- PC: 로그인 상태 -->
        <th:block th:if="${@layoutHelper.isLoggedIn(session.user)}">
          <a href="/add-figure" class="text-white hover:text-indigo-100 transition"
             aria-label="인물 추가">
            <i class="fas fa-plus-circle mr-1" aria-hidden="true"></i>
            <span>추가</span>
          </a>

          <!-- PC용 프로필 드롭다운 -->
          <div class="relative" x-data="{ open: false }">
            <button @click="open = !open" class="flex items-center focus:outline-none"
                    aria-haspopup="true" aria-expanded="false">
              <img th:src="${@layoutHelper.getProfileImage(session.user)}"
                   alt="프로필 이미지"
                   class="w-8 h-8 rounded-full border-2 border-white object-cover"
                   onerror="this.src='/img/profile-placeholder.svg';">
            </button>
            <div x-show="open"
                 @click.away="open = false"
                 x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0 scale-95"
                 x-transition:enter-end="opacity-100 scale-100"
                 class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50">
              <a href="/me" class="block px-4 py-2 text-sm text-gray-700 hover:bg-indigo-100">
                <i class="fas fa-user mr-2"></i> 내 정보 보기
              </a>
              <a href="/auth/logout"
                 class="block px-4 py-2 text-sm text-red-600 hover:bg-indigo-100">
                <i class="fas fa-sign-out-alt mr-2"></i> 로그아웃
              </a>
            </div>
          </div>
        </th:block>

        <!-- PC: 비로그인 상태 -->
        <th:block th:unless="${@layoutHelper.isLoggedIn(session.user)}">
          <a href="/add-figure" class="text-white hover:text-indigo-100 transition"
             aria-label="인물 추가">
            <i class="fas fa-plus-circle mr-1" aria-hidden="true"></i>
            <span>추가</span>
          </a>
          <a href="/login" class="text-white hover:text-indigo-100 transition" aria-label="로그인">
            <i class="fas fa-sign-in-alt mr-1" aria-hidden="true"></i>
            <span>로그인</span>
          </a>
        </th:block>
      </div>
    </nav>

    <!-- (4) 모바일 메뉴 패널: 비로그인 상태일 때 햄버거 버튼으로 열 수 있음 -->
    <div
        id="mobileMenu"
        class="md:hidden fixed inset-0 z-50 bg-white transform translate-x-full transition-transform duration-300 ease-in-out"
        role="dialog"
        aria-modal="true"
        aria-labelledby="mobileMenuButton">
      <div class="flex flex-col h-full">
        <!-- 모바일 메뉴 헤더 -->
        <div class="flex justify-between items-center p-4 border-b border-gray-200">
          <a href="/" class="flex items-center text-xl font-bold text-gray-800">
            <img src="/img/logo.svg" alt="국민사형투표 아이콘" class="h-8 mr-2">
            국민사형투표
          </a>
          <button
              id="mobileMenuCloseButton"
              class="text-gray-600 hover:text-gray-800 focus:outline-none"
              aria-label="메뉴 닫기">
            <i class="fas fa-times text-2xl"></i>
          </button>
        </div>

        <!-- 메뉴 콘텐츠 (비로그인 시 노출되는 메뉴) -->
        <div class="flex-grow overflow-y-auto p-4">
          <div class="space-y-4">
            <a href="/figures"
               class="flex items-center py-3 px-4 bg-gray-100 rounded-lg hover:bg-indigo-50 transition">
              <i class="fas fa-users text-indigo-600 mr-3 text-lg"></i>
              <span class="text-gray-800 font-medium">인물 목록</span>
            </a>
            <a href="/add-figure"
               class="flex items-center py-3 px-4 bg-gray-100 rounded-lg hover:bg-indigo-50 transition">
              <i class="fas fa-plus-circle text-green-600 mr-3 text-lg"></i>
              <span class="text-gray-800 font-medium">인물 추가</span>
            </a>
          </div>

          <!-- 로그인 상태 -->
          <th:block th:if="${@layoutHelper.isLoggedIn(session.user)}">
            <div class="mt-6 pt-6 border-t border-gray-200">
              <h3 class="text-xs font-semibold text-gray-500 mb-3 uppercase tracking-wider">
                내 메뉴
              </h3>
              <div class="space-y-4">
                <a href="/me"
                   class="flex items-center py-3 px-4 bg-gray-100 rounded-lg hover:bg-indigo-50 transition">
                  <i class="fas fa-user text-purple-600 mr-3 text-lg"></i>
                  <span class="text-gray-800 font-medium">내 정보</span>
                </a>
                <a href="/auth/logout"
                   class="flex items-center py-3 px-4 bg-red-50 rounded-lg hover:bg-red-100 transition">
                  <i class="fas fa-sign-out-alt text-red-600 mr-3 text-lg"></i>
                  <span class="text-red-800 font-medium">로그아웃</span>
                </a>
              </div>
            </div>
          </th:block>

          <!-- 비로그인 상태 -->
          <th:block th:unless="${@layoutHelper.isLoggedIn(session.user)}">
            <div class="mt-6 pt-6 border-t border-gray-200">
              <a href="/login"
                 class="flex items-center justify-center py-3 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                <i class="fas fa-sign-in-alt mr-2"></i>
                로그인
              </a>
            </div>
          </th:block>
        </div>
      </div>
    </div>

    <!-- (5) 모바일 메뉴 오버레이 -->
    <div
        id="mobileMenuOverlay"
        class="md:hidden fixed inset-0 bg-black bg-opacity-50 z-40 opacity-0 pointer-events-none transition-opacity duration-300"
        aria-hidden="true">
    </div>
  </div>
</header>

<!-- 알림 메시지 프래그먼트 (성공, 오류 등) -->
<th:block th:fragment="alerts">
  <div th:if="${success}" class="alert alert-success mb-6 fade-in">
    <div class="flex">
      <i class="fas fa-check-circle text-green-500 mr-3"></i>
      <span th:text="${success}">성공 메시지</span>
    </div>
  </div>

  <div th:if="${error}" class="alert alert-danger mb-6 fade-in">
    <div class="flex">
      <i class="fas fa-exclamation-circle text-red-500 mr-3"></i>
      <span th:text="${error}">오류 메시지</span>
    </div>
  </div>

  <div th:if="${info}" class="alert alert-info mb-6 fade-in">
    <div class="flex">
      <i class="fas fa-info-circle text-blue-500 mr-3"></i>
      <span th:text="${info}">정보 메시지</span>
    </div>
  </div>

  <div th:if="${warning}" class="alert alert-warning mb-6 fade-in">
    <div class="flex">
      <i class="fas fa-exclamation-triangle text-amber-500 mr-3"></i>
      <span th:text="${warning}">경고 메시지</span>
    </div>
  </div>
</th:block>

<!-- 로딩 표시 프래그먼트 -->
<div th:fragment="loading" class="flex justify-center items-center p-8 text-indigo-500">
  <i class="fas fa-spinner fa-spin text-2xl mr-2"></i>
  <span>로딩 중...</span>
</div>

<!-- 빈 상태 프래그먼트 (데이터가 없을 때) -->
<div th:fragment="empty-state(icon, message, description)"
     class="bg-gray-50 p-8 rounded-lg text-center fade-in">
  <i th:class="${icon ?: 'fas fa-info-circle'} + ' text-indigo-500 text-4xl mb-4'"></i>
  <p class="text-xl text-gray-600" th:text="${message ?: '데이터가 없습니다.'}">데이터가 없습니다.</p>
  <p th:if="${description}" class="text-gray-500 mt-2" th:text="${description}">추가 설명</p>
</div>

<!-- 페이지네이션 프래그먼트 -->
<div th:fragment="pagination(pageData, baseUrl)" th:if="${pageData.totalPages > 1}"
     class="mt-8 flex justify-center">
  <nav aria-label="페이지 탐색" class="pagination">
    <ul class="inline-flex rounded-md shadow">
      <!-- 이전 페이지 링크 -->
      <li th:classappend="${pageData.first} ? 'disabled' : ''">
        <a th:href="${pageData.first ? '#' : baseUrl + (pageData.number - 1)}"
           class="px-3 py-2 rounded-l-md border border-gray-300 bg-white text-gray-500 hover:bg-gray-50"
           th:classappend="${pageData.first} ? 'pointer-events-none opacity-50' : ''">
          이전
        </a>
      </li>

      <!-- 페이지 번호 -->
      <li th:each="i : ${#numbers.sequence(0, pageData.totalPages - 1)}"
          th:classappend="${pageData.number == i} ? 'active' : ''">
        <a th:href="${baseUrl + i}"
           th:text="${i + 1}"
           class="px-3 py-2 border-t border-b border-gray-300"
           th:classappend="${pageData.number == i} ? 'bg-indigo-50 text-indigo-600' : 'bg-white text-gray-500 hover:bg-gray-50'">
          1
        </a>
      </li>

      <!-- 다음 페이지 링크 -->
      <li th:classappend="${pageData.last} ? 'disabled' : ''">
        <a th:href="${pageData.last ? '#' : baseUrl + (pageData.number + 1)}"
           class="px-3 py-2 rounded-r-md border border-gray-300 bg-white text-gray-500 hover:bg-gray-50"
           th:classappend="${pageData.last} ? 'pointer-events-none opacity-50' : ''">
          다음
        </a>
      </li>
    </ul>
  </nav>
</div>

<!-- 댓글/답글 목록 항목 프래그먼트 -->
<div th:fragment="comment-item(comment, showReplies)"
     th:id="'comment-' + ${comment.id}"
     class="border-b border-gray-200 pb-6 comment-item fade-in">
  <div class="flex justify-between mb-2">
    <div class="flex items-center">
      <!-- 사용자 프로필 이미지 -->
      <a th:if="${comment.user != null}"
         th:href="@{'/users/' + ${comment.user.nickname}}">
        <img th:src="${@layoutHelper.getProfileImage(comment.user)}"
             alt="프로필 이미지"
             class="w-8 h-8 rounded-full mr-2 profile-image"
             onerror="this.src='/img/profile-placeholder.svg';">
      </a>
      <img th:unless="${comment.user != null}"
           src="/img/profile-placeholder.svg"
           alt="익명"
           class="w-8 h-8 rounded-full mr-2 profile-image">

      <div class="text-sm">
        <!-- 사용자 닉네임 표시 -->
        <a th:if="${comment.user != null}"
           th:href="@{'/users/' + ${comment.user.nickname}}"
           class="font-medium text-gray-900 hover:text-indigo-600 transition">
          <span th:text="${comment.user.nickname}">사용자 닉네임</span>
        </a>
        <span th:unless="${comment.user != null}" class="text-gray-500">익명</span>
        <span class="text-gray-500 ml-3"
              th:text="${@layoutHelper.toRelative(comment.createdAt)}">날짜</span>
      </div>
    </div>
  </div>

  <p class="text-gray-800 mb-3" th:text="${comment.content}">댓글 내용</p>

  <div class="flex items-center text-sm">
    <button class="flex items-center mr-4 text-gray-500 hover:text-green-500 transition"
            data-action="like-comment" th:data-comment-id="${comment.id}">
      <i class="fas fa-thumbs-up mr-1"></i>
      <span th:text="${comment.likes}" class="like-count">0</span>
    </button>
    <button class="flex items-center mr-4 text-gray-500 hover:text-red-500 transition"
            data-action="dislike-comment" th:data-comment-id="${comment.id}">
      <i class="fas fa-thumbs-down mr-1"></i>
      <span th:text="${comment.dislikes}" class="dislike-count">0</span>
    </button>

    <!-- 답글 달기 버튼: 로그인한 사용자는 활성화, 비로그인 사용자는 비활성화 -->
    <div th:if="${@layoutHelper.isLoggedIn(session.user)}">
      <button
          class="flex items-center text-gray-500 hover:text-indigo-500 transition reply-toggle-btn"
          th:data-comment-id="${comment.id}">
        <i class="fas fa-reply mr-1"></i>
        <span>답글 달기</span>
      </button>
    </div>
    <div th:unless="${@layoutHelper.isLoggedIn(session.user)}">
      <button class="flex items-center text-gray-500 opacity-60 cursor-not-allowed transition"
              disabled>
        <i class="fas fa-reply mr-1"></i>
        <span>답글 달기</span>
      </button>
    </div>

    <!-- 답글 보기 버튼 (댓글에 답글이 있을 경우) -->
    <button th:if="${comment.repliesCount > 0}"
            class="flex items-center ml-4 text-blue-500 hover:text-blue-700 transition view-replies-btn"
            th:data-comment-id="${comment.id}"
            th:data-reply-count="${comment.repliesCount}">
      <span th:text="'답글 ' + ${comment.repliesCount} + '개'">답글 0개</span>
      <i class="fas fa-chevron-down ml-1 text-xs"></i>
    </button>
  </div>

  <!-- 답글 작성 폼 -->
  <div th:id="'reply-form-' + ${comment.id}"
       class="mt-4 pl-6 border-l-2 border-gray-200 reply-form"
       style="display: none;">
    <div th:if="${@layoutHelper.isLoggedIn(session.user)}">
      <form
          th:action="@{'/' + ${categoryId} + '/@' + ${figureName} + '/comment/' + ${comment.id} + '/reply'}"
          method="post" class="reply-form-content">
        <div class="mb-2">
            <textarea name="content" rows="2"
                      class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm"
                      placeholder="답글을 입력하세요..."></textarea>
        </div>
        <div class="flex justify-end space-x-2">
          <button type="button"
                  class="text-gray-500 px-3 py-1 rounded text-sm cancel-reply-btn"
                  th:data-comment-id="${comment.id}">
            취소
          </button>
          <button type="submit"
                  class="bg-indigo-600 text-white px-3 py-1 rounded text-sm hover:bg-indigo-700 transition">
            <i class="fas fa-reply mr-1"></i> 답글 작성
          </button>
        </div>
      </form>
    </div>
    <div th:unless="${@layoutHelper.isLoggedIn(session.user)}"
         class="p-2 text-center text-gray-500">
      <a href="/login" class="text-indigo-600 hover:underline">로그인 후 답글 작성 가능합니다.</a>
    </div>
  </div>

  <!-- 답글 목록 컨테이너 -->
  <div th:if="${showReplies}"
       th:id="'replies-' + ${comment.id}"
       class="mt-4 pl-6 border-l-2 border-indigo-100 space-y-4 replies-container">
    <div th:replace="fragments/common :: reply-item(reply)"
         th:each="reply : ${comment.replies}"></div>
  </div>
  <div th:unless="${showReplies}"
       th:id="'replies-' + ${comment.id}"
       class="mt-4 pl-6 border-l-2 border-indigo-100 space-y-4 replies-container"
       style="display: none;">
    <div class="text-center py-2 replies-loading">
      <i class="fas fa-spinner fa-spin text-indigo-500"></i>
      <span class="ml-2 text-gray-500">답글을 불러오는 중...</span>
    </div>
  </div>
</div>

<!-- 답글 항목 프래그먼트 -->
<div th:fragment="reply-item(reply)"
     th:class="'reply-item pb-4 mb-4 border-b border-gray-100'"
     th:data-reply-id="${reply.id}">
  <div class="flex justify-between mb-1">
    <div class="flex items-center">
      <!-- 프로필 사진 -->
      <a th:href="${reply.userNickname ? '/users/' + reply.userNickname : '#'}"
         class="user-profile-link">
        <img th:src="${reply.userProfileImage ?: '/img/profile-placeholder.svg'}"
             alt="프로필 이미지"
             class="reply-profile-image w-8 h-8 rounded-full mr-2"
             onerror="this.src='/img/profile-placeholder.svg';">
      </a>
      <div class="text-sm">
        <!-- 사용자 닉네임 -->
        <a th:href="${reply.userNickname ? '/users/' + reply.userNickname : '#'}"
           class="reply-author-link font-medium text-gray-900 hover:text-indigo-600 transition">
          <span class="reply-author" th:text="${reply.userNickname ?: '익명'}">사용자 닉네임</span>
        </a>
        <span class="text-gray-500 ml-3 reply-date"
              th:text="${@layoutHelper.toRelative(reply.createdAt)}">날짜</span>
      </div>
    </div>
  </div>
  <p class="text-gray-800 mb-2 pl-10 reply-content" th:text="${reply.content}">답글 내용</p>

  <!-- 좋아요/싫어요 버튼 -->
  <div class="flex items-center text-sm pl-10">
    <button
        class="flex items-center mr-4 text-gray-500 hover:text-green-500 transition reply-like-btn"
        th:data-reply-id="${reply.id}">
      <i class="fas fa-thumbs-up mr-1"></i>
      <span class="reply-likes" th:text="${reply.likes}">0</span>
    </button>
    <button class="flex items-center text-gray-500 hover:text-red-500 transition reply-dislike-btn"
            th:data-reply-id="${reply.id}">
      <i class="fas fa-thumbs-down mr-1"></i>
      <span class="reply-dislikes" th:text="${reply.dislikes}">0</span>
    </button>
  </div>
</div>

<!-- 로그인 알림 프래그먼트 -->
<div th:fragment="login-prompt(message)"
     class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4 flex flex-col md:flex-row items-center">
  <i class="fas fa-info-circle text-blue-500 text-xl mb-2 md:mb-0 mr-0 md:mr-3"></i>
  <p class="text-gray-700 text-center md:text-left flex-grow"
     th:text="${message ?: '이 기능은 로그인이 필요합니다.'}">
    이 기능은 로그인이 필요합니다.
  </p>
  <a href="/login"
     class="mt-2 md:mt-0 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded transition-colors duration-200 flex items-center">
    <i class="fas fa-sign-in-alt mr-2"></i> 로그인하기
  </a>
</div>

<!-- 공유 버튼 프래그먼트 -->
<div th:fragment="share-buttons" class="flex justify-center space-x-4">
  <a href="#" data-action="share-twitter"
     class="w-10 h-10 flex items-center justify-center rounded-full bg-blue-400 text-white hover:bg-blue-500 transition">
    <i class="fab fa-twitter"></i>
  </a>
  <a href="#" data-action="share-facebook"
     class="w-10 h-10 flex items-center justify-center rounded-full bg-blue-600 text-white hover:bg-blue-700 transition">
    <i class="fab fa-facebook-f"></i>
  </a>
  <a href="#" data-action="share-link"
     class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-500 text-white hover:bg-gray-600 transition">
    <i class="fas fa-link"></i>
  </a>
</div>

<!-- 푸터 프래그먼트 -->
<footer th:fragment="footer" class="bg-gray-800 text-white py-6" itemscope
        itemtype="https://schema.org/WPFooter">
  <div class="container mx-auto px-4">
    <div class="flex flex-col md:flex-row justify-between items-center">
      <div class="mb-4 md:mb-0">
        <p>&copy; 2025 국민사형투표. All rights reserved.</p>
        <div class="text-gray-400 text-sm mt-2">
          <a href="/privacy" class="hover:text-white transition">개인정보처리방침</a> |
          <a href="/terms" class="hover:text-white transition">이용약관</a> |
          <a href="/sitemap.xml" class="hover:text-white transition">사이트맵</a>
        </div>
      </div>

      <!-- 소셜 미디어 링크 -->
      <div class="flex space-x-4">
        <a href="#" class="hover:text-indigo-300 transition" aria-label="트위터">
          <i class="fab fa-twitter" aria-hidden="true"></i>
        </a>
        <a href="#" class="hover:text-indigo-300 transition" aria-label="페이스북">
          <i class="fab fa-facebook" aria-hidden="true"></i>
        </a>
        <a href="#" class="hover:text-indigo-300 transition" aria-label="인스타그램">
          <i class="fab fa-instagram" aria-hidden="true"></i>
        </a>
      </div>
    </div>
  </div>
</footer>

<!-- 스크롤 상단 버튼 프래그먼트 -->
<button th:fragment="scroll-to-top" id="scrollToTopButton"
        class="fixed bottom-6 right-6 bg-indigo-600 text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center hidden focus:outline-none hover:bg-indigo-700 transition"
        aria-label="페이지 상단으로 이동">
  <i class="fas fa-arrow-up" aria-hidden="true"></i>
</button>

<!-- 공통 스크립트 프래그먼트 -->
<th:block th:fragment="common-scripts">
  <script src="/js/utils/common-utils.js"></script>
  <!-- 페이지 초기화 스크립트 -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // 전역 초기화 함수 호출
      CommonUtils.init();

      // 모바일 메뉴 스크립트
      const mobileMenuButton = document.getElementById('mobileMenuButton');
      const mobileMenu = document.getElementById('mobileMenu');
      const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
      const mobileMenuCloseButton = document.getElementById('mobileMenuCloseButton');

      function openMobileMenu() {
        if (!mobileMenu) {
          return;
        }
        mobileMenu.classList.remove('translate-x-full');
        mobileMenuOverlay.classList.remove('opacity-0', 'pointer-events-none');
        mobileMenuButton?.setAttribute('aria-expanded', 'true');
      }

      function closeMobileMenu() {
        if (!mobileMenu) {
          return;
        }
        mobileMenu.classList.add('translate-x-full');
        mobileMenuOverlay.classList.add('opacity-0', 'pointer-events-none');
        mobileMenuButton?.setAttribute('aria-expanded', 'false');
      }

      if (mobileMenuButton) {
        mobileMenuButton.addEventListener('click', openMobileMenu);
      }
      if (mobileMenuCloseButton) {
        mobileMenuCloseButton.addEventListener('click', closeMobileMenu);
      }
      if (mobileMenuOverlay) {
        mobileMenuOverlay.addEventListener('click', (e) => {
          if (e.target === mobileMenuOverlay) {
            closeMobileMenu();
          }
        });
      }
    });
  </script>
</th:block>
</body>
</html>